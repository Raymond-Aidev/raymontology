# RaymondsIndex v2.1 수정보완 작업 프롬프트

> **작성일**: 2025-12-30 08:25
> **목적**: RaymondsIndex 계산 로직 버그 수정 및 데이터 품질 개선
> **예상 작업 시간**: 2-3시간

---

## 작업 배경

RaymondsIndex v2.1 분석 결과 다음 문제가 발견되었습니다:

1. **투자괴리율 v2.1 계산 버그**: 67%가 -100, 13%가 +100으로 극단값 집중
2. **D등급 레거시 데이터**: 41건의 D등급 존재 (9등급 체계에 없음)
3. **등급-점수 불일치**: A등급 평균점수 66점 (기준: 80-87점)
4. **CAPEX 데이터 누락**: 2022-2024년 약 50% 누락
5. **특별규칙 위반 과다**: 55% (1,478건)가 위반으로 분류됨

---

## Phase 1: 계산 로직 버그 수정 (Critical)

### 작업 1.1: 투자괴리율 v2.1 계산 로직 개선

**파일**: `backend/app/services/raymonds_index_calculator.py`

**현재 문제**:
- `_calculate_investment_gap_v21()` 함수에서 CAPEX나 현금이 0인 경우 ±100%로 처리됨
- 라인 425-481

**수정 요구사항**:
```
1. CAPEX 데이터가 모두 0이거나 NULL인 경우 → 0.0 반환 (극단값 방지)
2. 현금 데이터가 모두 0인 경우 → 0.0 반환
3. 범위 제한을 -100 ~ +100에서 → -50 ~ +50으로 완화 검토
4. 디버그 로깅 추가하여 극단값 발생 원인 추적
```

**수정 후 검증**:
```bash
# 샘플 10개 기업으로 테스트
cd /Users/jaejoonpark/raymontology/backend
python scripts/calculate_raymonds_index.py --limit 10

# 극단값 분포 확인
PGPASSWORD=ooRdnLPpUTvrYODqhYqvhWwwQtsnmjnR psql -h hopper.proxy.rlwy.net -p 41316 -U postgres -d railway -c "
SELECT investment_gap_v21, COUNT(*) as cnt
FROM raymonds_index
WHERE fiscal_year = 2025
GROUP BY investment_gap_v21
ORDER BY cnt DESC LIMIT 10;"
```

### 작업 1.2: 등급 판정 로직 검증

**파일**: `backend/app/services/raymonds_index_calculator.py`

**현재 문제**:
- A등급(2건)의 평균점수가 66.10점 (기준: 80-87점)
- 점수와 등급 불일치

**확인 필요**:
```
1. _determine_grade() 함수 (라인 1066-1071) 점수 기준 확인
2. _apply_special_rules() 함수 (라인 1073-1103) 등급 강제 조정 확인
3. 특별규칙 적용 시 점수도 함께 조정되는지 확인
```

**검증 쿼리**:
```sql
-- 등급별 점수 범위 확인
SELECT grade,
       MIN(total_score) as min_score,
       MAX(total_score) as max_score,
       ROUND(AVG(total_score)::numeric, 2) as avg_score,
       COUNT(*) as cnt
FROM raymonds_index
WHERE fiscal_year = 2025
GROUP BY grade
ORDER BY avg_score DESC;
```

---

## Phase 2: 레거시 데이터 정리 (High)

### 작업 2.1: D등급 레코드 처리

**현황**: 41건의 D등급 존재 (v2.1 9등급 체계에 없음)

**방법 A - SQL 직접 변환** (권장):
```sql
-- D등급 → C등급으로 변환
UPDATE raymonds_index
SET grade = 'C'
WHERE grade = 'D';

-- 변환 결과 확인
SELECT grade, COUNT(*) FROM raymonds_index GROUP BY grade ORDER BY grade;
```

**방법 B - 재계산**:
```bash
# D등급 기업만 재계산
cd /Users/jaejoonpark/raymontology/backend
PGPASSWORD=ooRdnLPpUTvrYODqhYqvhWwwQtsnmjnR psql -h hopper.proxy.rlwy.net -p 41316 -U postgres -d railway -c "
SELECT DISTINCT c.name
FROM raymonds_index ri
JOIN companies c ON ri.company_id = c.id
WHERE ri.grade = 'D';" | while read company; do
    python scripts/calculate_raymonds_index.py --company "$company"
done
```

---

## Phase 3: 전체 재계산 (High)

### 작업 3.1: 백엔드 수정 후 전체 재계산

**사전 조건**: Phase 1 완료 후 진행

**실행**:
```bash
cd /Users/jaejoonpark/raymontology/backend

# 로그 디렉토리 확인
mkdir -p logs

# 전체 재계산 실행 (약 20-30분 소요)
python scripts/calculate_raymonds_index.py

# 또는 특정 연도만
python scripts/calculate_raymonds_index.py --year 2025
```

**재계산 후 검증**:
```bash
# 등급 분포 확인
PGPASSWORD=ooRdnLPpUTvrYODqhYqvhWwwQtsnmjnR psql -h hopper.proxy.rlwy.net -p 41316 -U postgres -d railway -c "
SELECT fiscal_year, grade, COUNT(*) as cnt,
       ROUND(AVG(total_score)::numeric, 2) as avg_score
FROM raymonds_index
GROUP BY fiscal_year, grade
ORDER BY fiscal_year DESC, grade;"

# 투자괴리율 분포 개선 확인
PGPASSWORD=ooRdnLPpUTvrYODqhYqvhWwwQtsnmjnR psql -h hopper.proxy.rlwy.net -p 41316 -U postgres -d railway -c "
SELECT
    CASE
        WHEN investment_gap_v21 <= -50 THEN '~-50'
        WHEN investment_gap_v21 <= -20 THEN '-50~-20'
        WHEN investment_gap_v21 <= 0 THEN '-20~0'
        WHEN investment_gap_v21 <= 20 THEN '0~20'
        WHEN investment_gap_v21 <= 50 THEN '20~50'
        ELSE '50~'
    END as range,
    COUNT(*) as cnt
FROM raymonds_index
WHERE fiscal_year = 2025
GROUP BY 1
ORDER BY 1;"
```

---

## Phase 4: 데이터 품질 개선 (Medium)

### 작업 4.1: CAPEX 데이터 보완 (선택)

**현황**:
- 2022년: 48.4% (1,166/2,409)
- 2023년: 47.0% (1,220/2,595)
- 2024년: 52.1% (1,426/2,736)

**스크립트**: `backend/scripts/parse_local_financial_details.py`

```bash
# 현금흐름표에서 CAPEX 재추출 (시간 소요 큼)
cd /Users/jaejoonpark/raymontology/backend
python scripts/parse_local_financial_details.py --sample 100  # 테스트
# python scripts/parse_local_financial_details.py  # 전체 실행
```

### 작업 4.2: 기타금융자산 데이터 보완 (선택)

**현황**:
- other_financial_assets_current: 70% 보유
- other_assets_current: 74% 보유

**스크립트**: `backend/scripts/parse_missing_other_assets.py`

```bash
cd /Users/jaejoonpark/raymontology/backend
python scripts/parse_missing_other_assets.py --verify-only  # 현황만 확인
# python scripts/parse_missing_other_assets.py  # 전체 실행
```

---

## Phase 5: 특별규칙 임계값 검토 (Medium)

### 작업 5.1: 특별규칙 완화 검토

**현황**: 55% (1,478건)가 특별규칙 위반

**현재 기준** (`raymonds_index_calculator.py` 라인 1073-1103):
- 현금-유형자산 비율 > 30:1 → B- 제한
- 조달자금 전환율 < 30% → B- 제한
- 단기금융상품비율 > 65% + CAPEX 감소 → B 제한

**검토 필요**:
```sql
-- 각 규칙별 위반 건수 확인
SELECT
    SUM(CASE WHEN cash_tangible_ratio > 30 THEN 1 ELSE 0 END) as rule1_cash_tangible,
    SUM(CASE WHEN fundraising_utilization >= 0 AND fundraising_utilization < 30 THEN 1 ELSE 0 END) as rule2_fundraising,
    SUM(CASE WHEN short_term_ratio > 65 AND capex_trend = 'decreasing' THEN 1 ELSE 0 END) as rule3_short_term,
    SUM(CASE WHEN violation_count >= 2 THEN 1 ELSE 0 END) as multi_violation
FROM raymonds_index
WHERE fiscal_year = 2025;
```

**완화 제안** (필요시):
- 현금-유형자산 비율: 30:1 → 50:1
- 조달자금 전환율: 30% → 20%
- 단기금융상품비율: 65% → 70%

---

## 작업 완료 체크리스트

### Phase 1: 계산 로직 수정
- [ ] `_calculate_investment_gap_v21()` 극단값 처리 개선
- [ ] 디버그 로깅 추가
- [ ] 샘플 10개 테스트 완료

### Phase 2: 레거시 정리
- [ ] D등급 41건 처리 완료
- [ ] 등급 분포 9개 체계로 정리

### Phase 3: 전체 재계산
- [ ] 계산 로직 수정 후 전체 재계산 실행
- [ ] 등급 분포 정상화 확인
- [ ] 투자괴리율 분포 개선 확인

### Phase 4: 데이터 품질 (선택)
- [ ] CAPEX 데이터 보완 여부 결정
- [ ] 기타금융자산 데이터 보완 여부 결정

### Phase 5: 특별규칙 검토 (선택)
- [ ] 각 규칙별 위반 현황 분석
- [ ] 임계값 완화 여부 결정

---

## 참조 파일 경로

| 파일 | 용도 |
|------|------|
| `backend/app/services/raymonds_index_calculator.py` | 핵심 계산 로직 |
| `backend/scripts/calculate_raymonds_index.py` | 배치 재계산 스크립트 |
| `backend/scripts/parse_local_financial_details.py` | 재무데이터 파싱 |
| `backend/scripts/parse_missing_other_assets.py` | 누락 데이터 보완 |
| `docs/RAYMONDSINDEX_UI_SPEC_v2.md` | UI 설계 문서 |
| `docs/RAYMONDSINDEX_DEVELOPMENT_PLAN.md` | 개발 계획서 |
| `backend/scripts/SCHEMA_REGISTRY.md` | DB 스키마 참조 |

---

## DB 접속 정보

```bash
# 프로덕션 PostgreSQL
PGPASSWORD=ooRdnLPpUTvrYODqhYqvhWwwQtsnmjnR psql -h hopper.proxy.rlwy.net -p 41316 -U postgres -d railway

# 빠른 조회용
alias ri_psql='PGPASSWORD=ooRdnLPpUTvrYODqhYqvhWwwQtsnmjnR psql -h hopper.proxy.rlwy.net -p 41316 -U postgres -d railway'
```

---

## 긴급 롤백 방법

문제 발생 시:
```bash
# 재계산 전 백업 (권장)
PGPASSWORD=ooRdnLPpUTvrYODqhYqvhWwwQtsnmjnR pg_dump -h hopper.proxy.rlwy.net -p 41316 -U postgres -d railway -t raymonds_index > raymonds_index_backup_$(date +%Y%m%d).sql

# 롤백
PGPASSWORD=ooRdnLPpUTvrYODqhYqvhWwwQtsnmjnR psql -h hopper.proxy.rlwy.net -p 41316 -U postgres -d railway < raymonds_index_backup_YYYYMMDD.sql
```
